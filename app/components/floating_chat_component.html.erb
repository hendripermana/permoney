<div
  data-controller="floating-chat"
  data-floating-chat-open-value="false"
  class="fixed bottom-4 right-4 z-50 lg:bottom-6 lg:right-6">

  <%# Chat Trigger Button %>
  <button
    data-action="click->floating-chat#toggle"
    data-floating-chat-target="trigger"
    type="button"
    aria-label="Open AI Chat"
    class="flex items-center justify-center w-14 h-14 rounded-full bg-surface text-primary shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-alpha-black-200 theme-dark:focus:ring-alpha-white-300">
    <%= helpers.icon("message-circle", size: "lg") %>

    <%# Notification Badge (if needed) %>
    <span class="absolute -top-1 -right-1 w-5 h-5 bg-destructive text-white text-xs font-bold rounded-full hidden items-center justify-center" data-floating-chat-target="badge">
      1
    </span>
  </button>

  <%# Chat Panel %>
  <div
    data-floating-chat-target="panel"
    data-transition-enter="transition ease-out duration-300"
    data-transition-enter-start="opacity-0 translate-y-4 lg:translate-y-0 lg:scale-95"
    data-transition-enter-end="opacity-100 translate-y-0 lg:scale-100"
    data-transition-leave="transition ease-in duration-200"
    data-transition-leave-start="opacity-100 translate-y-0 lg:scale-100"
    data-transition-leave-end="opacity-0 translate-y-4 lg:translate-y-0 lg:scale-95"
    class="hidden opacity-0 translate-y-4 lg:translate-y-0 lg:scale-95 fixed inset-0 lg:inset-auto lg:bottom-20 lg:right-0 lg:w-[400px] lg:h-[600px] bg-container lg:rounded-2xl shadow-xl border border-primary overflow-hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="floating-chat-title">

    <%# Chat Header %>
    <div class="flex items-center justify-between p-4 border-b border-primary bg-surface">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center">
          <%= helpers.icon("sparkles", size: "sm", color: "white") %>
        </div>
        <div>
          <h2 id="floating-chat-title" class="text-sm font-semibold text-primary">AI Assistant</h2>
          <p class="text-xs text-secondary">Ask me anything about your finances</p>
        </div>
      </div>

      <button
        data-action="click->floating-chat#close"
        type="button"
        aria-label="Close chat"
        class="p-2 rounded-lg hover:bg-container-inset transition-colors">
        <%= helpers.icon("x", size: "sm") %>
      </button>
    </div>

    <%# Chat Content - Turbo Frame %>
    <div class="flex-1 overflow-hidden">
      <% if @user.ai_enabled? %>
        <%= turbo_frame_tag "floating_chat_content",
          src: new_chat? ? new_chat_path(floating: true) : chat_path(chat, floating: true),
          loading: "lazy",
          class: "h-full flex flex-col" do %>
          <div class="flex items-center justify-center h-full">
            <div class="flex flex-col items-center gap-3 text-secondary">
              <%= helpers.icon("loader-circle", size: "lg", class: "animate-spin") %>
              <p class="text-sm">Loading chat...</p>
            </div>
          </div>
        <% end %>
      <% else %>
        <%= render "chats/floating_ai_consent" %>
      <% end %>
    </div>
  </div>

  <%# Backdrop for mobile %>
  <div
    data-floating-chat-target="backdrop"
    data-action="click->floating-chat#close"
    class="hidden fixed inset-0 bg-alpha-black-500 lg:!hidden"
    aria-hidden="true">
  </div>
</div>
