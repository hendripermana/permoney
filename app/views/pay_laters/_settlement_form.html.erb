<%# Reusable Early Settlement Form Partial %>
<% pay_later = account.accountable %>

<%= form_with url: process_early_settlement_pay_later_path(account), 
    method: :post,
    data: { turbo_frame: "settlement_form", turbo_confirm: "Are you sure you want to settle all remaining installments? This action cannot be undone." },
    class: "space-y-6" do |f| %>

  <%# Error Messages %>
  <% if error.present? %>
    <div class="bg-red-50 theme-dark:bg-red-900/20 border border-red-200 theme-dark:border-red-800 rounded-lg p-4">
      <div class="flex items-start">
        <%= icon("alert-triangle", class: "w-5 h-5 text-red-600 mt-0.5 mr-2") %>
        <div>
          <h3 class="text-sm font-semibold text-red-900 theme-dark:text-red-100">Settlement Error</h3>
          <p class="text-sm text-red-600 theme-dark:text-red-400 mt-1"><%= error %></p>
        </div>
      </div>
    </div>
  <% end %>

  <%# Settlement Amount (Read-only) %>
  <div>
    <%= label_tag :settlement_amount_display, "Settlement Amount", class: "block text-sm font-medium text-primary mb-2" %>
    <div class="relative">
      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-secondary font-medium">
        <%= account.currency %>
      </span>
      <%= text_field_tag :settlement_amount_display,
          settlement_amount.format,
          disabled: true,
          class: "w-full pl-16 pr-4 py-3 text-lg font-bold border border-primary rounded-lg bg-container-inset text-primary" %>
    </div>
    <p class="text-xs text-secondary mt-2">
      This amount will pay off all <%= pay_later.installments.unpaid.count %> remaining installment(s)
    </p>
  </div>

  <%# Source Account %>
  <div>
    <%= label_tag :source_account_id, "Pay From", class: "block text-sm font-medium text-primary mb-2" %>
    <%= select_tag :source_account_id,
        options_from_collection_for_select(
          source_accounts,
          :id,
          ->(acc) { "#{acc.name} (#{acc.balance_money.format})" },
          source_accounts.first&.id
        ),
        {
          required: true,
          class: "w-full px-4 py-3 border border-primary rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
        } %>
    
    <%# Balance Check Warning %>
    <% selected_account = source_accounts.first %>
    <% if selected_account && selected_account.balance < settlement_amount.amount %>
      <div class="mt-2 bg-yellow-50 theme-dark:bg-yellow-900/20 border border-yellow-200 theme-dark:border-yellow-800 rounded p-3">
        <p class="text-xs text-yellow-900 theme-dark:text-yellow-100 flex items-start">
          <%= icon("alert-triangle", class: "w-3 h-3 mr-1 mt-0.5") %>
          <span>Selected account balance is lower than settlement amount. Payment may fail.</span>
        </p>
      </div>
    <% end %>
  </div>

  <%# Settlement Date %>
  <div>
    <%= label_tag :settlement_date, "Settlement Date", class: "block text-sm font-medium text-primary mb-2" %>
    <%= date_field_tag :settlement_date,
        Date.current,
        max: Date.current,
        required: true,
        class: "w-full px-4 py-3 border border-primary rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" %>
  </div>

  <%# Settlement Breakdown %>
  <div class="bg-green-50 theme-dark:bg-green-900/20 border border-green-200 theme-dark:border-green-800 rounded-lg p-4">
    <p class="text-sm font-semibold text-green-900 theme-dark:text-green-100 mb-3">Settlement Breakdown</p>
    <div class="space-y-2 text-sm">
      <div class="flex justify-between">
        <span class="text-green-600 theme-dark:text-green-400">Outstanding Principal</span>
        <span class="font-semibold text-green-900 theme-dark:text-green-100">
          <%= Money.new(pay_later.installments.unpaid.sum(&:principal_amount), account.currency).format %>
        </span>
      </div>
      <div class="flex justify-between">
        <span class="text-green-600 theme-dark:text-green-400">
          Remaining <%= pay_later.sharia_compliant? ? "Profit" : "Interest" %>
        </span>
        <span class="font-semibold text-green-900 theme-dark:text-green-100">
          <%= Money.new(pay_later.installments.unpaid.sum(&:interest_amount), account.currency).format %>
        </span>
      </div>
      <% if pay_later.early_settlement_fee && pay_later.early_settlement_fee > 0 %>
        <div class="flex justify-between">
          <span class="text-green-600 theme-dark:text-green-400">Early Settlement Fee</span>
          <span class="font-semibold text-green-900 theme-dark:text-green-100">
            <%= pay_later.early_settlement_fee_money.format %>
          </span>
        </div>
      <% end %>
      <div class="pt-2 border-t border-green-300 flex justify-between">
        <span class="text-green-900 theme-dark:text-green-100 font-bold">Total Settlement</span>
        <span class="font-bold text-green-900 theme-dark:text-green-100 text-lg">
          <%= settlement_amount.format %>
        </span>
      </div>
    </div>
  </div>

  <%# Confirmation Notice %>
  <div class="bg-blue-50 theme-dark:bg-blue-900/20 border border-blue-200 theme-dark:border-blue-800 rounded-lg p-4">
    <div class="flex items-start">
      <%= icon("info", class: "w-5 h-5 text-blue-600 mt-0.5 mr-2") %>
      <div class="flex-1">
        <h4 class="text-sm font-semibold text-blue-900 theme-dark:text-blue-100">After Settlement</h4>
        <ul class="text-sm text-blue-800 mt-2 space-y-1 list-disc list-inside">
          <li>All <%= pay_later.installments.unpaid.count %> installments will be marked as paid</li>
          <li>Your full credit limit of <%= pay_later.credit_limit_money.format %> will be restored</li>
          <li>A transfer entry will be created in your transaction history</li>
          <li>Your payment record will show 100% completion</li>
          <li>You can make new purchases immediately after settlement</li>
        </ul>
      </div>
    </div>
  </div>

  <%# Submit Buttons %>
  <div class="flex items-center justify-between pt-4 border-t border-primary">
    <%= link_to "Cancel",
        account_path(account),
        class: "inline-flex items-center px-6 py-3 bg-surface-inset text-primary rounded-lg hover:bg-gray-200 transition font-medium",
        data: { turbo_frame: "_top" } %>

    <div class="flex gap-3">
      <%= link_to new_payment_pay_later_path(account),
          class: "inline-flex items-center px-6 py-3 bg-container text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 theme-dark:bg-blue-900/20 transition font-medium",
          data: { turbo_frame: "_top" } do %>
        <%= icon("arrow-left", class: "w-4 h-4 mr-2") %>
        Regular Payment
      <% end %>

      <%= submit_tag "Settle All Installments",
          class: "inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" %>
    </div>
  </div>

  <%# Final Warning %>
  <div class="bg-yellow-50 theme-dark:bg-yellow-900/20 border-2 border-yellow-300 rounded-lg p-4">
    <div class="flex items-start">
      <%= icon("alert-circle", class: "w-5 h-5 text-yellow-600 mt-0.5 mr-2") %>
      <div class="flex-1">
        <p class="text-sm font-semibold text-yellow-900 theme-dark:text-yellow-100">
          Please Confirm Before Proceeding
        </p>
        <p class="text-sm text-yellow-900 theme-dark:text-yellow-100 mt-1">
          You will be charged <%= settlement_amount.format %> immediately. 
          This action cannot be undone. Make sure your source account has sufficient balance.
        </p>
      </div>
    </div>
  </div>
<% end %>
