<%# Reusable Payment Form Partial %>
<% pay_later = account.accountable %>

<%= form_with url: process_payment_pay_later_path(account), 
    method: :post,
    data: { turbo_frame: "payment_form" },
    class: "space-y-6" do |f| %>

  <%# Error Messages %>
  <% if error.present? %>
    <div class="bg-red-50 theme-dark:bg-red-900/20 border border-red-200 theme-dark:border-red-800 rounded-lg p-4">
      <div class="flex items-start">
        <%= icon("alert-triangle", class: "w-5 h-5 text-red-600 mt-0.5 mr-2") %>
        <div>
          <h3 class="text-sm font-semibold text-red-900 theme-dark:text-red-100">Payment Error</h3>
          <p class="text-sm text-red-600 theme-dark:text-red-400 mt-1"><%= error %></p>
        </div>
      </div>
    </div>
  <% end %>

  <%# Payment Amount %>
  <div>
    <%= label_tag :amount, "Payment Amount", class: "block text-sm font-medium text-primary mb-2" %>
    <div class="relative">
      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-secondary font-medium">
        <%= account.currency %>
      </span>
      <%= number_field_tag :amount,
          pay_later.next_due_installment&.total_due,
          placeholder: "0.00",
          step: "0.01",
          min: "0.01",
          required: true,
          class: "w-full pl-16 pr-4 py-3 text-lg border border-primary rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
    </div>
    
    <%# Quick Amount Suggestions %>
    <div class="flex gap-2 mt-2">
      <% if pay_later.next_due_installment %>
        <button type="button"
                onclick="document.getElementById('amount').value = '<%= pay_later.next_due_installment.total_due %>'"
                class="px-3 py-1 text-xs bg-blue-100 text-blue-600 theme-dark:text-blue-400 rounded hover:bg-blue-200 transition">
          Next Due: <%= Money.new(pay_later.next_due_installment.total_due, account.currency).format %>
        </button>
      <% end %>
      <% if pay_later.outstanding_balance > 0 %>
        <button type="button"
                onclick="document.getElementById('amount').value = '<%= pay_later.outstanding_balance %>'"
                class="px-3 py-1 text-xs bg-green-100 text-green-600 theme-dark:text-green-400 rounded hover:bg-green-200 transition">
          Full Balance: <%= pay_later.outstanding_balance_money.format %>
        </button>
      <% end %>
    </div>
    
    <p class="text-xs text-secondary mt-2">
      <%= icon("info", class: "inline-block w-3 h-3 mr-1") %>
      You can pay any amount. Overpayments will be applied to future installments.
    </p>
  </div>

  <%# Source Account %>
  <div>
    <%= label_tag :source_account_id, "Pay From", class: "block text-sm font-medium text-primary mb-2" %>
    <%= select_tag :source_account_id,
        options_from_collection_for_select(
          source_accounts,
          :id,
          ->(acc) { "#{acc.name} (#{acc.balance_money.format})" },
          source_accounts.first&.id
        ),
        {
          required: true,
          class: "w-full px-4 py-3 border border-primary rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        } %>
    <p class="text-xs text-secondary mt-2">
      Select the account to make payment from
    </p>
  </div>

  <%# Payment Date %>
  <div>
    <%= label_tag :payment_date, "Payment Date", class: "block text-sm font-medium text-primary mb-2" %>
    <%= date_field_tag :payment_date,
        Date.current,
        max: Date.current,
        required: true,
        class: "w-full px-4 py-3 border border-primary rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
    <p class="text-xs text-secondary mt-2">
      Backdated payments allowed for record-keeping purposes
    </p>
  </div>

  <%# Notes %>
  <div>
    <%= label_tag :notes, "Notes (Optional)", class: "block text-sm font-medium text-primary mb-2" %>
    <%= text_area_tag :notes,
        nil,
        placeholder: "Add any notes about this payment...",
        rows: 3,
        class: "w-full px-4 py-3 border border-primary rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
  </div>

  <%# Payment Impact Preview %>
  <div class="bg-blue-50 theme-dark:bg-blue-900/20 border border-blue-200 theme-dark:border-blue-800 rounded-lg p-4">
    <p class="text-sm font-semibold text-blue-900 theme-dark:text-blue-100 mb-3">Payment Impact</p>
    <div class="space-y-2 text-sm">
      <div class="flex justify-between items-center">
        <span class="text-blue-600 theme-dark:text-blue-400">Current Outstanding</span>
        <span class="font-semibold text-blue-900 theme-dark:text-blue-100">
          <%= pay_later.outstanding_balance_money.format %>
        </span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-blue-600 theme-dark:text-blue-400">Payment Amount</span>
        <span class="font-semibold text-blue-900 theme-dark:text-blue-100" id="payment-preview-amount">
          <%= Money.new(0, account.currency).format %>
        </span>
      </div>
      <div class="pt-2 border-t border-blue-200 theme-dark:border-blue-800 flex justify-between items-center">
        <span class="text-blue-900 theme-dark:text-blue-100 font-medium">After Payment</span>
        <span class="font-bold text-blue-900 theme-dark:text-blue-100" id="payment-preview-remaining">
          <%= pay_later.outstanding_balance_money.format %>
        </span>
      </div>
    </div>
  </div>

  <%# Important Notes %>
  <div class="bg-yellow-50 theme-dark:bg-yellow-900/20 border border-yellow-200 theme-dark:border-yellow-800 rounded-lg p-4">
    <div class="flex items-start">
      <%= icon("info", class: "w-5 h-5 text-yellow-600 mt-0.5 mr-2") %>
      <div class="flex-1">
        <h4 class="text-sm font-semibold text-yellow-900 theme-dark:text-yellow-100">Payment Processing</h4>
        <ul class="text-sm text-yellow-900 theme-dark:text-yellow-100 mt-2 space-y-1 list-disc list-inside">
          <li>Payments are applied to installments in chronological order</li>
          <li>Interest/profit portion will be recorded as a separate expense</li>
          <li>Your available credit will be updated immediately after payment</li>
          <li>A transfer entry will be created in your transaction history</li>
        </ul>
      </div>
    </div>
  </div>

  <%# Submit Buttons %>
  <div class="flex items-center justify-between pt-4 border-t border-primary">
    <%= link_to "Cancel",
        account_path(account),
        class: "inline-flex items-center px-6 py-3 bg-surface-inset text-primary rounded-lg hover:bg-gray-200 transition font-medium",
        data: { turbo_frame: "_top" } %>

    <div class="flex gap-3">
      <% if pay_later.early_settlement_allowed && pay_later.outstanding_balance > 0 %>
        <%= link_to early_settlement_pay_later_path(account),
            class: "inline-flex items-center px-6 py-3 bg-container text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50 theme-dark:bg-blue-900/20 transition font-medium",
            data: { turbo_frame: "_top" } do %>
          <%= icon("zap", class: "w-4 h-4 mr-2") %>
          Early Settlement
        <% end %>
      <% end %>

      <%= submit_tag "Process Payment",
          class: "inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed" %>
    </div>
  </div>
<% end %>

<script>
  // Update payment preview in real-time
  document.addEventListener('turbo:load', function() {
    const amountInput = document.getElementById('amount');
    if (amountInput) {
      amountInput.addEventListener('input', function() {
        const paymentAmount = parseFloat(this.value) || 0;
        const outstanding = <%= pay_later.outstanding_balance %>;
        const remaining = Math.max(0, outstanding - paymentAmount);
        
        const currency = '<%= account.currency %>';
        document.getElementById('payment-preview-amount').textContent = 
          new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(paymentAmount);
        document.getElementById('payment-preview-remaining').textContent = 
          new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(remaining);
      });
    }
  });
</script>
