<%# Turbo Stream Response for Installment Preview %>
<% if @error %>
  <%= turbo_stream.update "installment_preview" do %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex items-start">
        <%= icon("alert-triangle", class: "w-5 h-5 text-red-600 mt-0.5 mr-2") %>
        <div>
          <h3 class="text-sm font-semibold text-red-900">Preview Error</h3>
          <p class="text-sm text-red-700 mt-1"><%= @error %></p>
        </div>
      </div>
    </div>
  <% end %>
<% else %>
  <%= turbo_stream.update "installment_preview" do %>
    <div class="bg-white rounded-lg border border-gray-200 p-6">
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">
          <%= icon("calendar", class: "inline-block w-5 h-5 mr-2") %>
          Installment Schedule Preview
        </h3>
        <p class="text-sm text-gray-600">
          This is a preview of your payment schedule. Review before confirming the purchase.
        </p>
      </div>

      <%# Summary Cards %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 rounded-lg p-4">
          <p class="text-sm text-blue-700 mb-1">Purchase Amount</p>
          <p class="text-2xl font-bold text-blue-600">
            <%= Money.new(@installments.sum { |i| i[:principal_amount] }, @account.currency).format %>
          </p>
        </div>
        <div class="bg-orange-50 rounded-lg p-4">
          <p class="text-sm text-orange-700 mb-1">Total <%= @pay_later.sharia_compliant? ? "Profit" : "Interest" %></p>
          <p class="text-2xl font-bold text-orange-600">
            <%= Money.new(@total_interest, @account.currency).format %>
          </p>
          <% effective_rate = (@total_interest / @installments.sum { |i| i[:principal_amount] } * 100).round(2) rescue 0 %>
          <p class="text-xs text-orange-600 mt-1"><%= effective_rate %>% total</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <p class="text-sm text-gray-700 mb-1">Total Cost</p>
          <p class="text-2xl font-bold text-gray-900">
            <%= Money.new(@total_cost, @account.currency).format %>
          </p>
          <p class="text-xs text-gray-600 mt-1"><%= @installments.count %> installments</p>
        </div>
      </div>

      <%# Installment Table %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Principal</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                <%= @pay_later.sharia_compliant? ? "Profit" : "Interest" %>
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Due</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @installments.each do |installment| %>
              <tr class="<%= installment[:installment_no] == 1 ? 'bg-blue-50' : 'hover:bg-gray-50' %>">
                <td class="px-4 py-3 text-sm text-gray-900">
                  #<%= installment[:installment_no] %>
                  <% if installment[:installment_no] == 1 %>
                    <span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">First</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <%= installment[:due_date].strftime("%b %d, %Y") %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <%= Money.new(installment[:principal_amount], @account.currency).format %>
                </td>
                <td class="px-4 py-3 text-sm">
                  <% if installment[:interest_amount] > 0 %>
                    <span class="text-gray-900">
                      <%= Money.new(installment[:interest_amount], @account.currency).format %>
                    </span>
                    <% if installment[:applied_rate] %>
                      <span class="text-xs text-gray-500 block">
                        <%= (installment[:applied_rate] * 100).round(2) %>%
                      </span>
                    <% end %>
                  <% else %>
                    <span class="text-green-600 flex items-center">
                      <%= icon("check-circle", class: "w-3 h-3 mr-1") %>
                      Free
                    </span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-900">
                  <%= Money.new(installment[:total_due], @account.currency).format %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%# Important Notes %>
      <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex items-start">
          <%= icon("info", class: "w-5 h-5 text-yellow-600 mt-0.5 mr-2") %>
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-yellow-900">Important Notes</h4>
            <ul class="text-sm text-yellow-800 mt-2 space-y-1 list-disc list-inside">
              <% if @pay_later.free_interest_months > 0 %>
                <li>First <%= @pay_later.free_interest_months %> installment(s) are interest-free!</li>
              <% end %>
              <li>Late payments may incur additional fees (First 7 days: <%= @pay_later.late_fee_first7_money.format %>, then <%= @pay_later.late_fee_per_day_money.format %>/day)</li>
              <% if @pay_later.early_settlement_allowed %>
                <li>Early settlement is allowed 
                  <% if @pay_later.early_settlement_fee && @pay_later.early_settlement_fee > 0 %>
                    with <%= @pay_later.early_settlement_fee_money.format %> fee
                  <% else %>
                    without penalty
                  <% end %>
                </li>
              <% end %>
              <li>This is a preview. Final schedule will be created upon purchase confirmation.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
