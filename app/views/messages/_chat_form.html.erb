<%# locals: (chat: nil, message_hint: nil, floating: false, message: nil) %>

<div id="chat-form" class="w-full">
  <% message_hint = local_assigns.fetch(:message_hint, nil) %>
  <% floating = local_assigns.fetch(:floating, false) %>
  <% message_record = local_assigns.fetch(:message, nil) || (defined?(@message) && @message.is_a?(Message) ? @message : nil) %>
  <% if chat && chat.persisted? %>
    <% message_record = message_record if message_record.is_a?(Message) %>
  <% else %>
    <% message_record = nil %>
  <% end %>
  <% model = if chat && chat.persisted?
    message_record ||= Message.new
    [chat, message_record]
  else
    chat || Chat.new
  end %>
  <% form_options = {
    class: "flex flex-col w-full bg-container",
    data: { chat_target: "form" }
  } %>
  <% if floating %>
    <% form_options[:url] =
      if chat && chat.persisted?
        form_options[:scope] = :message
        chat_messages_path(chat, floating: true)
      else
        chats_path(floating: true)
      end %>
  <% elsif chat && chat.persisted? %>
    <% form_options[:url] = chat_messages_path(chat) %>
    <% form_options[:scope] = :message %>
  <% else %>
    <% form_options[:url] = chats_path %>
  <% end %>

  <% error_model = model.is_a?(Array) ? model.last : model %>
  <% if error_model&.errors&.any? %>
    <div class="px-2 py-1">
      <%= render "shared/form_errors", model: error_model %>
    </div>
  <% end %>

  <%= form_with model: model, **form_options.merge(data: { controller: "chat-input", chat_target: "form" }) do |f| %>

    <%# In the future, this will be a dropdown with different AI models %>
    <%= f.hidden_field :ai_model, value: default_ai_model %>

    <div class="flex items-center gap-2 px-3 py-3 lg:py-2.5">
      <% text_area_options = {
        placeholder: "Ask about your finances...",
        class: "flex-1 border-0 focus:ring-2 focus:ring-primary/20 text-sm resize-none bg-transparent placeholder:text-secondary min-h-[24px] max-h-[120px] rounded-lg transition-all duration-200",
        data: { 
          chat_target: "input",
          chat_input_target: "textarea",
          action: "input->chat#autoResize input->chat-input#autoResize keydown->chat#handleInputKeyDown keydown->chat-input#handleKeydown" 
        },
        rows: 1
      } %>
      <% if message_hint.present? %>
        <% text_area_options[:value] = message_hint %>
      <% end %>

      <%= f.text_area :content, **text_area_options %>

      <%# Stop generation button (shown during streaming) %>
      <button
        type="button"
        data-chat-streaming-target="stopButton"
        data-action="click->chat-streaming#stopGeneration"
        class="hidden flex-shrink-0 w-10 h-10 lg:w-9 lg:h-9 rounded-lg border border-primary/30 text-secondary hover:text-primary hover:bg-surface-inset transition-all duration-200 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-0 active:scale-95"
        aria-label="Stop generation"
        title="Stop generation">
        <%= icon("square", size: "sm") %>
      </button>

      <%# Send button - Fully clickable, no truncation %>
      <button
        type="submit"
        data-chat-input-target="submitButton"
        class="flex-shrink-0 w-10 h-10 lg:w-9 lg:h-9 rounded-lg bg-primary text-white flex items-center justify-center hover:bg-primary/90 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-0 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
        aria-label="Send message"
        title="Send message (Ctrl+Enter)">
        <%= icon("arrow-up", size: "sm") %>
      </button>
    </div>

    <%# Disclaimer text - Improved typography %>
    <div class="px-3 pb-2 lg:pb-1.5 text-center">
      <p class="text-xs text-secondary/80">
        <% if floating %>
          AI responses are informational only.
        <% else %>
          AI responses are informational only and are not financial advice.
        <% end %>
      </p>
    </div>
  <% end %>
</div>
