<%# Enhanced loan form with smart field ordering and contextual defaults %>
<%# locals: (loan_form:, account:, personal_mode:, borrowed_enabled:, preview_base_href:) %>

<div class="space-y-6" data-controller="enhanced-loan-form" data-enhanced-loan-form-personal-mode-value="<%= personal_mode %>" data-preview-base-href="<%= preview_base_href %>">
  
  <!-- Step 1: Loan Type Selection (Prominent) -->
  <section class="space-y-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
        <span class="text-sm font-semibold text-primary">1</span>
      </div>
      <div>
        <h3 class="text-lg font-medium text-primary">What type of loan is this?</h3>
        <p class="text-sm text-secondary">Choose the type to get the right fields and smart defaults</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
      <!-- Personal Loan Card -->
      <label class="cursor-pointer h-full flex"
             data-enhanced-loan-form-target="personalCard"
             data-action="click->enhanced-loan-form#selectPersonal">
        <div class="loan-type-card w-full h-full flex flex-col min-h-[120px] p-4 border-2 border-secondary rounded-lg bg-container transition-all duration-200 ease-out hover:border-primary/40 hover:shadow-md active:scale-[0.98] data-[selected=true]:border-primary data-[selected=true]:bg-primary/5 data-[selected=true]:ring-2 data-[selected=true]:ring-primary data-[selected=true]:ring-offset-0 data-[selected=true]:shadow-sm" data-selected="<%= personal_mode ? 'true' : 'false' %>">
          <div class="flex items-start gap-3 flex-1">
            <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center flex-shrink-0">
              <%= icon "users", size: "sm", class: "text-green-600" %>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-medium text-primary">Personal Loan</h4>
              <p class="text-sm text-secondary mt-1">From family, friends, or colleagues</p>
              <div class="mt-2 text-xs text-green-600 font-medium">
                ✓ Usually interest-free • ✓ Flexible terms • ✓ Quick setup
              </div>
            </div>
          </div>
        </div>
      </label>

      <!-- Institutional Loan Card -->
      <label class="cursor-pointer h-full flex"
             data-enhanced-loan-form-target="institutionalCard"
             data-action="click->enhanced-loan-form#selectInstitutional">
        <div class="loan-type-card w-full h-full flex flex-col min-h-[120px] p-4 border-2 border-secondary rounded-lg bg-container transition-all duration-200 ease-out hover:border-primary/40 hover:shadow-md active:scale-[0.98] data-[selected=true]:border-primary data-[selected=true]:bg-primary/5 data-[selected=true]:ring-2 data-[selected=true]:ring-primary data-[selected=true]:ring-offset-0 data-[selected=true]:shadow-sm" data-selected="<%= personal_mode ? 'false' : 'true' %>">
          <div class="flex items-start gap-3 flex-1">
            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0">
              <%= icon "building-2", size: "sm", class: "text-blue-600" %>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-medium text-primary">Institutional Loan</h4>
              <p class="text-sm text-secondary mt-1">From banks, fintech, or institutions</p>
              <div class="mt-2 text-xs text-blue-600 font-medium">
                ✓ Formal terms • ✓ Interest rates • ✓ Detailed tracking
              </div>
            </div>
          </div>
        </div>
      </label>
    </div>
  </section>

  <!-- Step 2: Essential Information (Contextual based on type) -->
  <section class="space-y-4" data-enhanced-loan-form-target="essentialSection">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
        <span class="text-sm font-semibold text-primary">2</span>
      </div>
      <div>
        <h3 class="text-lg font-medium text-primary">Essential Information</h3>
        <p class="text-sm text-secondary">Basic details needed for your loan</p>
      </div>
    </div>

    <!-- Personal Loan Fields (Shown when personal selected) -->
    <div class="space-y-4" data-enhanced-loan-form-target="personalFields">
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <h4 class="font-medium text-green-800 mb-3 flex items-center gap-2">
          <%= icon "users", size: "sm" %>
          Personal Loan Details
        </h4>
        
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <%= loan_form.text_field :counterparty_name, 
                                   label: "Lender's name", 
                                   placeholder: "e.g., Ahmad, Ana, John",
                                   required: true,
                                   data: { "enhanced-loan-form-target": "lenderName" } %>
            
            <%= loan_form.select :relationship,
                                [
                                  ["Family member", "family"],
                                  ["Friend", "friend"], 
                                  ["Colleague", "colleague"],
                                  ["Business partner", "business_partner"],
                                  ["Other", "other"]
                                ],
                                { label: "Relationship", include_blank: "Select relationship..." },
                                { data: { "enhanced-loan-form-target": "relationship" } } %>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <%= loan_form.money_field :initial_balance,
                                     label: "Loan amount",
                                     default_currency: Current.family.currency,
                                     required: true,
                                     placeholder: "0",
                                     label_tooltip: "Total amount originally borrowed when the loan started.",
                                     data: { "enhanced-loan-form-target": "loanAmount" } %>
            
            <%= loan_form.number_field :term_months,
                                     label: "Repayment period (months)",
                                     placeholder: smart_term_months_default(true),
                                     min: 1,
                                     max: 120,
                                     label_tooltip: "How many months you plan to take to finish repaying this loan.",
                                     data: { "enhanced-loan-form-target": "termMonths" } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Institutional Loan Fields (Shown when institutional selected) -->
    <div class="space-y-4 hidden" data-enhanced-loan-form-target="institutionalFields">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="font-medium text-blue-800 mb-3 flex items-center gap-2">
          <%= icon "building-2", size: "sm" %>
          Institutional Loan Details
        </h4>
        
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <%= loan_form.text_field :counterparty_name,
                                   label: "Institution name",
                                   placeholder: "e.g., Bank Mandiri, BCA, Kredivo",
                                   required: true,
                                   data: { "enhanced-loan-form-target": "institutionName" } %>
            
            <%= loan_form.select :fintech_type,
                                Loan::FINTECH_TYPES.map { |key, meta| [meta[:long], key] },
                                { label: "Institution type", include_blank: "Select type..." },
                                { data: { "enhanced-loan-form-target": "fintechType" } } %>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <%= loan_form.money_field :initial_balance,
                                     label: "Loan amount",
                                     default_currency: Current.family.currency,
                                     required: true,
                                     placeholder: "0",
                                     label_tooltip: "Total amount originally borrowed when the loan started.",
                                     data: { "enhanced-loan-form-target": "loanAmount" } %>
            
            <%= loan_form.number_field :term_months,
                                     label: "Repayment period (months)",
                                     placeholder: smart_term_months_default(false),
                                     min: 1,
                                     max: 360,
                                     label_tooltip: "How many months remain (or total agreed months) for this loan.",
                                     data: { "enhanced-loan-form-target": "termMonths" } %>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 3: Interest & Terms (Smart defaults based on type) -->
  <section class="space-y-4" data-enhanced-loan-form-target="interestSection">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
        <span class="text-sm font-semibold text-primary">3</span>
      </div>
      <div>
        <h3 class="text-lg font-medium text-primary">Interest & Terms</h3>
        <p class="text-sm text-secondary">Set up interest rates and payment terms</p>
      </div>
    </div>

    <!-- Smart Interest Section -->
    <div class="space-y-4">
      <!-- Interest-Free Toggle for Personal Loans -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-4" data-enhanced-loan-form-target="personalInterestSection">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium text-green-800">Interest-Free Loan</h4>
            <p class="text-sm text-green-700">Most personal loans don't charge interest</p>
          </div>
          <%= loan_form.check_box :interest_free,
                                 {
                                   checked: true,
                                   class: "w-4 h-4 text-green-600 bg-container border-secondary rounded focus:ring-green-500",
                                   data: { "enhanced-loan-form-target": "interestFree" }
                                 },
                                 "1", "0" %>
        </div>
      </div>

      <!-- Interest Rate Fields -->
      <div class="space-y-4" data-enhanced-loan-form-target="interestFields">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <%= loan_form.number_field :interest_rate,
                                   label: "Interest rate (%)",
                                   placeholder: smart_interest_rate_default(personal_mode, false),
                                   min: 0,
                                   max: 100,
                                   step: 0.01,
                                   label_tooltip: "Annual interest or profit rate charged by the lender (APR).",
                                   data: { "enhanced-loan-form-target": "interestRate" } %>
          
          <%= loan_form.select :rate_type,
                              [["Fixed", "fixed"], ["Variable", "variable"], ["Adjustable", "adjustable"]],
                              { label: "Rate type", include_blank: "Select type...", label_tooltip: "Fixed rate stays the same; variable or adjustable can change over time." },
                              { data: { "enhanced-loan-form-target": "rateType" } } %>
        </div>
      </div>

      <!-- Payment Frequency -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <%= loan_form.select :payment_frequency,
                            loan_payment_frequency_options,
                            { label: "Payment frequency", label_tooltip: "How often installments are due (monthly, weekly, etc.)." },
                            { data: { "enhanced-loan-form-target": "paymentFrequency" } } %>
        
        <%= loan_form.date_field :start_date,
                               label: "Start date",
                               value: Date.current.next_month,
                               label_tooltip: "Date when the next installment is expected to be paid.",
                               data: { "enhanced-loan-form-target": "startDate" } %>
      </div>
    </div>
  </section>

  <!-- Step 4: Disbursement (For new loans only) -->
  <% unless account.linked? %>
    <section class="space-y-4" data-enhanced-loan-form-target="disbursementSection">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
          <span class="text-sm font-semibold text-primary">4</span>
        </div>
        <div>
          <h3 class="text-lg font-medium text-primary">Money Transfer</h3>
          <p class="text-sm text-secondary">Where did the loan money go?</p>
        </div>
      </div>

      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <%= loan_form.collection_select :disbursement_account_id,
                                          Current.family.accounts.assets.alphabetically,
                                          :id, :name,
                                          { label: "Destination account", required: true, 
                                            label_tooltip: "Cash/bank account where the loan was disbursed." },
                                          { required: true } %>
            
            <%= loan_form.date_field :origination_date,
                                   label: "Transfer date",
                                   value: Date.current,
                                   label_tooltip: "Date when the loan funds were originally transferred to you.",
                                   data: { "enhanced-loan-form-target": "originationDate" } %>
          </div>
          <p class="text-xs text-secondary">
            This creates a transfer from the loan to your selected account, keeping your cashflow accurate.
          </p>
        </div>
      </div>
    </section>
  <% end %>

  <!-- Advanced Options (Collapsed by default) -->
  <details class="group space-y-4" data-enhanced-loan-form-target="advancedSection">
    <summary class="cursor-pointer text-primary font-medium flex items-center justify-between gap-3 px-4 py-3 rounded-lg border border-transparent hover:border-secondary hover:bg-secondary/5 transition-all duration-200 ease-out group-open:border-secondary group-open:bg-secondary/5 focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2">
      <div class="flex items-center gap-2">
        <%= icon "settings", size: "sm", class: "text-secondary" %>
        <span>Advanced Options</span>
        <span class="text-xs text-secondary font-normal">(Optional)</span>
      </div>
      <%= icon "chevron-down", size: "sm", class: "text-secondary transition-transform duration-200 ease-out group-open:rotate-180 flex-shrink-0" %>
    </summary>
    
    <div class="mt-4 space-y-4 border border-secondary rounded-lg p-4 bg-container">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <%= loan_form.select :schedule_method,
                            loan_schedule_method_options,
                            { label: "Payment calculation method", label_tooltip: "Choose how principal and interest are allocated (annuity, flat, bullet, etc.)." },
                            { data: { "enhanced-loan-form-target": "scheduleMethod" } } %>
        
        <%= loan_form.money_field :balloon_amount,
                                 label: "Balloon payment (optional)",
                                 default_currency: Current.family.currency,
                                 placeholder: "0",
                                 label_tooltip: "Optional lump-sum that will be added to the final installment.",
                                 data: { "enhanced-loan-form-target": "balloonAmount" } %>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <%= loan_form.text_area :collateral_desc,
                               label: "Collateral description",
                               rows: 2,
                               placeholder: "e.g., Car, Property, etc." %>
        
        <%= loan_form.text_area :agreement_notes,
                               label: "Agreement notes",
                               rows: 2,
                               placeholder: "Any special terms or conditions" %>
      </div>
      
      <%= loan_form.text_area :notes,
                             label: "Private notes",
                             rows: 2,
                             placeholder: "Personal notes (only visible to you)" %>
    </div>
  </details>

  <!-- Schedule Preview (If enabled) -->
  <% if borrowed_enabled %>
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-medium text-primary">Payment Schedule</h3>
          <p class="text-sm text-secondary">Preview your repayment plan</p>
        </div>
        <%= render DS::Link.new(
          text: "Preview schedule",
          variant: "secondary",
          icon: "table",
          href: preview_base_href,
          data: { enhanced_loan_form_target: "previewLink", action: "click->enhanced-loan-form#preparePreview" }
        ) %>
      </div>
    </section>
  <% end %>

  <!-- Submit Section -->
  <section class="border-t border-secondary pt-6">
    <div class="flex items-center justify-end">
      <%= render DS::Button.new(
        text: account.new_record? ? "Create loan account" : "Save loan changes",
        variant: "primary",
        size: "lg",
        icon: account.new_record? ? "plus" : "save",
        type: "submit",
        class: "px-6 py-3"
      ) %>
    </div>
  </section>

  <!-- Hidden fields for form submission -->
  <%= loan_form.hidden_field :debt_kind, data: { "enhanced-loan-form-target": "debtKindField" } %>
  <%= loan_form.hidden_field :counterparty_type, data: { "enhanced-loan-form-target": "counterpartyTypeField" } %>
  <%= loan_form.hidden_field :compliance_type, value: "conventional" %>
</div>
