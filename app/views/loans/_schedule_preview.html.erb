<%# locals: (rows:, account: nil, initial_amount: nil, principal_amount: nil) %>
<% rows = Array(rows) %>
<% currency = account&.currency || Current.family.currency %>
<% total_principal = rows.sum { |row| row.principal.to_d } rescue 0.to_d %>
<% total_interest = rows.sum { |row| row.interest.to_d } rescue 0.to_d %>
<% total_payment = rows.sum { |row| row.total.to_d } rescue 0.to_d %>
<% first_due = rows.first&.due_date %>
<% last_due = rows.last&.due_date %>
<% installment_count = rows.size %>
<% interest_free = total_interest.zero? %>
<% outstanding_amount = begin
     value = local_assigns[:principal_amount] || total_principal
     BigDecimal(value.to_s)
   rescue
     total_principal.to_d
   end %>
<% initial_amount = begin
     value = local_assigns.key?(:initial_amount) ? local_assigns[:initial_amount] : nil
     value ||= account&.accountable&.initial_balance
     value ||= outstanding_amount
     BigDecimal(value.to_s)
   rescue
     outstanding_amount
   end %>
<% paid_amount = (initial_amount - outstanding_amount) if initial_amount && outstanding_amount && initial_amount > outstanding_amount %>
<% financing_class = interest_free ? "text-success" : "text-primary" %>

<div class="space-y-6">
  <% if rows.present? && total_payment.positive? %>
    <div class="grid gap-3 md:grid-cols-3">
      <div class="rounded-xl border border-primary/20 bg-container p-4 shadow-sm">
        <p class="text-xs font-semibold uppercase tracking-wide text-secondary">Remaining principal</p>
        <p class="mt-1 text-lg font-semibold text-primary">
          <%= number_to_currency(outstanding_amount, unit: currency) %>
        </p>
        <p class="mt-2 flex items-center gap-2 text-xs text-secondary">
          <%= icon "calendar", size: "xs" %>
          Starts <%= first_due ? l(first_due) : "—" %>
        </p>
        <% if paid_amount && paid_amount.positive? %>
          <p class="mt-1 text-xs text-secondary">
            Original <%= number_to_currency(initial_amount, unit: currency) %> • Paid so far <%= number_to_currency(paid_amount, unit: currency) %>
          </p>
        <% end %>
      </div>

      <div class="rounded-xl border border-primary/20 bg-container p-4 shadow-sm">
        <p class="text-xs font-semibold uppercase tracking-wide text-secondary">Total repayments</p>
        <p class="mt-1 text-lg font-semibold text-primary">
          <%= number_to_currency(total_payment, unit: currency) %>
        </p>
        <p class="mt-2 text-xs text-secondary">
          <span class="font-medium text-primary"><%= installment_count %></span> installments • Final due <%= last_due ? l(last_due) : "—" %>
        </p>
      </div>

      <div class="rounded-xl border border-primary/20 bg-container p-4 shadow-sm">
        <p class="text-xs font-semibold uppercase tracking-wide text-secondary">Financing cost</p>
        <p class="mt-1 text-lg font-semibold <%= financing_class %>">
          <%= number_to_currency(total_interest, unit: currency) %>
        </p>
        <p class="mt-2 text-xs text-secondary">
          <%= interest_free ? "Interest-free schedule" : "Interest / profit collected over the term" %>
        </p>
      </div>
    </div>
  <% end %>

  <% if rows.blank? || total_payment.zero? %>
    <div class="rounded-xl border border-dashed border-primary/30 bg-container-subtle p-6 text-center">
      <div class="mx-auto mb-3 flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
        <%= icon "table", size: "sm" %>
      </div>
      <p class="text-sm font-medium text-primary">No schedule yet</p>
      <p class="text-xs text-secondary">Fill in the loan amount, term, and start date to generate a preview.</p>
    </div>
  <% else %>
    <% remaining_principal = outstanding_amount %>
    <div class="overflow-hidden rounded-xl border border-primary/20 bg-container shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3 border-b border-primary/10 px-4 py-3">
        <div>
          <p class="text-sm font-semibold text-primary">Installment schedule</p>
          <p class="text-xs text-secondary">
            Next payment <%= first_due ? l(first_due) : "—" %> • Final payment <%= last_due ? l(last_due) : "—" %>
          </p>
        </div>
        <span class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-medium text-primary">
          <%= pluralize(installment_count, "installment") %>
        </span>
      </div>

      <div class="max-h-[60vh] overflow-auto">
        <table class="min-w-full divide-y divide-primary/10 text-sm">
          <thead class="bg-container-subtle text-xs font-semibold uppercase tracking-wide text-secondary">
            <tr>
              <th scope="col" class="py-3 pl-4 pr-4 text-left">#</th>
              <th scope="col" class="py-3 pr-4 text-left">Due date</th>
              <th scope="col" class="py-3 pr-4 text-right">Principal</th>
              <th scope="col" class="py-3 pr-4 text-right">Interest / Profit</th>
              <th scope="col" class="py-3 pr-4 text-right">Payment</th>
              <th scope="col" class="py-3 pr-4 text-right">Remaining principal</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-primary/10 bg-container">
            <% rows.each_with_index do |row, index| %>
              <% remaining_principal = [remaining_principal - row.principal.to_d, 0].max %>
              <tr class="transition hover:bg-container-subtle">
                <td class="py-3 pl-4 pr-4 text-xs font-medium text-secondary"><%= index + 1 %></td>
                <td class="py-3 pr-4 text-sm text-primary"><%= row.due_date ? l(row.due_date) : "—" %></td>
                <td class="py-3 pr-4 text-right tabular-nums text-primary"><%= number_to_currency(row.principal, unit: currency) %></td>
                <td class="py-3 pr-4 text-right tabular-nums text-secondary"><%= number_to_currency(row.interest, unit: currency) %></td>
                <td class="py-3 pr-4 text-right tabular-nums font-medium text-primary"><%= number_to_currency(row.total, unit: currency) %></td>
                <td class="py-3 pr-4 text-right tabular-nums text-secondary"><%= number_to_currency(remaining_principal, unit: currency) %></td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="bg-container-subtle text-sm">
            <tr>
              <td colspan="2" class="py-3 pl-4 pr-4 text-left font-medium text-secondary">Totals</td>
              <td class="py-3 pr-4 text-right font-semibold text-primary"><%= number_to_currency(total_principal, unit: currency) %></td>
              <td class="py-3 pr-4 text-right font-semibold text-primary"><%= number_to_currency(total_interest, unit: currency) %></td>
              <td class="py-3 pr-4 text-right font-semibold text-primary"><%= number_to_currency(total_payment, unit: currency) %></td>
              <td class="py-3 pr-4 text-right text-secondary">—</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  <% end %>
</div>
