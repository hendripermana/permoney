<%# locals: (account:, url:) %>

<% borrowed_enabled = Rails.application.config.respond_to?(:features) && ActiveModel::Type::Boolean.new.cast(Rails.application.config.features&.dig(:loans, :borrowed, :enabled)) %>
<% preview_base_href = account.persisted? ? schedule_preview_loan_path(account) : schedule_preview_loans_path %>

<%= render "accounts/form",
           account: account,
           url: url,
           form_prefix: nil,
           form_data: { turbo: false },
           hide_submit: true,
           hide_account_fields: true do |form| %>
  <%= render "shared/ruler", classes: "my-4" %>

  <div class="space-y-6">
    <%= form.fields_for :accountable do |loan_form| %>
      <% current_subtype = form.object.subtype.presence || "loan_personal" %>
      <% form.object.subtype ||= current_subtype %>
      <% debt_kind = loan_form.object.debt_kind.presence || (current_subtype == "loan_personal" ? "personal" : "institutional") %>
      <% personal_mode = debt_kind == "personal" %>

      <% loan_form.object.debt_kind ||= debt_kind %>
      <% loan_form.object.counterparty_type ||= (personal_mode ? "person" : "institution") %>

      <section class="section-card space-y-3 mb-6">
        <h3 class="text-base font-medium text-primary">Account details</h3>
        <p class="text-xs text-secondary">Tell us how you want this loan account to appear on your dashboard.</p>
        <div class="space-y-3">
          <%= form.text_field :name,
                              label: t("accounts.form.name_label", default: "Account name"),
                              placeholder: smart_loan_name_placeholder(personal_mode) %>
          <% unless account.linked? %>
            <%= form.money_field :balance,
                                 label: t("accounts.form.balance", default: "Current balance"),
                                 required: true,
                                 default_currency: Current.family.currency,
                                 label_tooltip: t("loans.form.current_balance.tooltip", default: "Outstanding principal right now. Use this when you start tracking a loan that already existed."),
                                 data: { "enhanced-loan-form-target": "currentBalance" } %>
          <% end %>

          <%= render "accounts/provider_fields",
                     form: form,
                     account: account,
                     show_domain: false,
                     show_notes: false,
                     manual_label: "Provider or institution",
                     manual_placeholder: "e.g. Bank Mandiri, BCA",
                     return_to: params[:return_to] %>
        </div>
      </section>

      <%= render "loans/enhanced_form",
              loan_form: loan_form,
              account: account,
              personal_mode: personal_mode,
              borrowed_enabled: borrowed_enabled,
              preview_base_href: preview_base_href %>
    <% end %>
  </div>
<% end %>
