<%# locals: (account:) %>

<div class="grid grid-cols-3 gap-2">
  <%= summary_card title: t(".original_principal") do %>
    <%= format_money account.loan.original_balance %>
  <% end %>

  <%= summary_card title: t(".remaining_principal") do %>
    <%= format_money account.balance_money %>
  <% end %>

  <%= summary_card title: account.loan.rate_label do %>
    <% if account.loan.sharia_compliant? %>
      <% if account.loan.islamic_product_type == "murabaha" && account.loan.margin_rate.present? %>
        <%= number_to_percentage(account.loan.margin_rate, precision: 3) %>
        <span class="text-xs text-secondary block">Margin Rate</span>
      <% elsif account.loan.islamic_product_type.in?(%w[musyarakah mudharabah]) && account.loan.profit_sharing_ratio.present? %>
        <%= number_to_percentage(account.loan.profit_sharing_ratio * 100, precision: 1) %>
        <span class="text-xs text-secondary block">Profit Share</span>
      <% elsif account.loan.islamic_product_type == "qard_hasan" %>
        <span class="text-success">Interest-Free</span>
        <span class="text-xs text-secondary block">Qard Hasan</span>
      <% else %>
        <%= t(".unknown") %>
      <% end %>
    <% elsif account.loan.interest_rate.present? %>
      <%= number_to_percentage(account.loan.interest_rate, precision: 3) %>
      <span class="text-xs text-secondary block">Interest Rate</span>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".monthly_payment") do %>
    <% if account.loan.rate_type.present? && account.loan.rate_type != 'fixed' %>
      <%= t(".not_applicable") %>
    <% elsif account.loan.rate_type == 'fixed' && account.loan.monthly_payment.present? %>
      <%= format_money(account.loan.monthly_payment) %>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".term") do %>
    <% if account.loan.term_months.present? %>
      <% if account.loan.term_months < 12 %>
        <%= pluralize(account.loan.term_months, "month") %>
      <% else %>
        <%= pluralize(account.loan.term_months / 12, "year") %>
      <% end %>
    <% else %>
      <%= t(".unknown") %>
    <% end %>
  <% end %>

  <%= summary_card title: t(".type") do %>
    <%= account.loan.rate_type&.titleize || t(".unknown") %>
  <% end %>
</div>

<% if account.accountable.personal_loan? %>
  <div class="bg-container p-4 rounded-lg mt-6">
    <h4 class="font-medium text-primary mb-1">Personal Loan Actions</h4>
    <% if (label = personal_lender_label(account.accountable)) %>
      <p class="text-sm text-secondary mb-4">Counterparty: <%= label %></p>
    <% end %>
    
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <%= render DS::Link.new(
        text: "Borrow More Money",
        variant: "primary",
        icon: "plus",
        href: new_borrowing_loan_path(account),
        frame: :modal,
        class: "w-full"
      ) %>
      
      <%= render DS::Link.new(
        text: "Make Payment",
        variant: "secondary",
        icon: "credit-card",
        href: new_payment_loan_path(account),
        frame: :modal,
        class: "w-full"
      ) %>
      <% if Rails.application.config.features.loans.extra_payment %>
        <%= render DS::Link.new(
          text: "Extra Payment",
          variant: "ghost",
          icon: "circle-plus",
          href: new_extra_payment_loan_path(account),
          frame: :modal,
          class: "w-full"
        ) %>
      <% end %>
    </div>

    <div class="mt-4 pt-4 border-t border-primary">
      <div class="text-xs text-secondary space-y-1">
        <% if account.accountable.sharia_compliant? %>
          <div class="flex items-center gap-2">
            <%= icon "check-circle", size: "xs", class: "text-success" %>
            <span>Syariah Compliant - No Interest Charges</span>
          </div>
        <% end %>
        <% if (label = personal_lender_label(account.accountable)) %>
          <p>• Use "Borrow More" if you need additional funds from <%= label %></p>
          <p>• Use "Make Payment" for partial or full repayments to <%= label %></p>
        <% else %>
          <p>• Use "Borrow More" to record additional loan disbursements</p>
          <p>• Use "Make Payment" for loan repayments</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<%# CTA to create first payment based on next planned installment %>
<% if (next_installment = account.loan_installments.pending.order(:installment_no).first) %>
  <div class="flex justify-center mt-4">
    <%= render DS::Link.new(
      text: "Create first payment",
      variant: "secondary",
      icon: "calendar-check",
      href: new_payment_loan_path(account, amount: next_installment.total_amount),
      frame: :modal
    ) %>
  </div>
<% end %>

<div class="flex justify-center py-8">
  <%= render DS::Link.new(
    text: "Edit loan details",
    variant: "ghost",
    href: edit_loan_path(account),
    frame: :modal
  ) %>
</div>
