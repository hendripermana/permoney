<%# Subscription Analytics Charts - Theme Aware %>
<% spending_data = @analytics.spending_chart_data %>
<% category_data = @analytics.category_chart_data %>
<% upcoming = @analytics.upcoming_payments_timeline.first(5) %>
<% mom_change = @analytics.month_over_month_change %>
<% total_spending = category_data.sum { |c| c[:amount] } %>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
  <!-- Monthly Spending Trend - Wave Chart -->
  <div class="bg-container rounded-xl border border-primary p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-primary">Monthly Spending</h3>
        <p class="text-sm text-secondary">Last 6 months trend</p>
      </div>
      <% if mom_change[:direction] != "flat" %>
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium <%= mom_change[:direction] == "up" ? "bg-red-100 text-red-700 theme-dark:bg-red-900/20 theme-dark:text-red-300" : "bg-green-100 text-green-700 theme-dark:bg-green-900/20 theme-dark:text-green-300" %>">
          <%= icon mom_change[:direction] == "up" ? "trending-up" : "trending-down", class: "h-4 w-4" %>
          <span><%= mom_change[:percent].abs %>%</span>
        </div>
      <% end %>
    </div>

    <% if spending_data[:values].present? && spending_data[:values].size >= 2 %>
      <div
        id="spending-wave-chart"
        class="h-48 w-full"
        data-controller="wave-area-chart"
        data-wave-area-chart-data-value="<%= spending_data.to_json %>"
        data-wave-area-chart-gradient-color-value="<%= mom_change[:direction] == "up" ? "#EF4444" : "#22C55E" %>"
        data-wave-area-chart-stroke-width-value="2"
        data-wave-area-chart-fill-opacity-value="0.15"
        data-wave-area-chart-curve-type-value="monotoneX"></div>
    <% else %>
      <div class="h-48 flex items-center justify-center text-secondary">
        <div class="text-center">
          <%= icon "bar-chart-3", class: "h-12 w-12 mx-auto mb-2 opacity-50" %>
          <p>Add subscriptions to see spending trends</p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Spending by Category - Horizontal Bar Chart -->
  <div class="bg-container rounded-xl border border-primary p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-primary">Spending by Category</h3>
        <p class="text-sm text-secondary">Monthly breakdown</p>
      </div>
      <span class="text-lg font-bold text-primary">
        <%= Money.new(@analytics.mrr, Current.family.currency).format(no_cents_if_whole: true) %>
      </span>
    </div>

    <% if category_data.present? && category_data.any? %>
      <div class="space-y-3">
        <% category_data.first(5).each do |cat| %>
          <% bar_width = total_spending > 0 ? (cat[:amount] / total_spending * 100).round(1) : 0 %>
          <div class="group">
            <div class="flex items-center justify-between mb-1.5">
              <div class="flex items-center gap-2">
                <span class="text-base"><%= cat[:icon] %></span>
                <span class="text-sm font-medium text-primary"><%= cat[:name] %></span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-primary"><%= cat[:formatted] %></span>
                <span class="text-xs text-secondary">(<%= cat[:percent_formatted] %>)</span>
              </div>
            </div>
            <div class="h-2 bg-gray-100 theme-dark:bg-gray-800 rounded-full overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-300 group-hover:opacity-80"
                style="width: <%= bar_width %>%; background-color: <%= cat[:color] %>;"></div>
            </div>
          </div>
        <% end %>

        <% if category_data.size > 5 %>
          <p class="text-xs text-secondary text-center pt-2">+ <%= category_data.size - 5 %> more categories</p>
        <% end %>
      </div>
    <% else %>
      <div class="h-48 flex items-center justify-center text-secondary">
        <div class="text-center">
          <%= icon "bar-chart-2", class: "h-12 w-12 mx-auto mb-2 opacity-50" %>
          <p>No category data available</p>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Upcoming Payments Timeline -->
<% if upcoming.any? %>
  <div class="bg-container rounded-xl border border-primary p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-primary">Upcoming Payments</h3>
        <p class="text-sm text-secondary">Next 30 days</p>
      </div>
      <span class="text-sm font-medium text-primary">
        Total: <%= Money.new(upcoming.sum { |u| u[:amount] }, Current.family.currency).format %>
      </span>
    </div>

    <div class="space-y-2">
      <% upcoming.each do |payment| %>
        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-surface-hover transition-colors">
          <div class="flex items-center gap-3">
            <% if payment[:logo_url].present? %>
              <%= image_tag payment[:logo_url], class: "w-9 h-9 rounded-lg object-cover", loading: "lazy" %>
            <% else %>
              <div class="w-9 h-9 rounded-lg bg-gray-100 theme-dark:bg-gray-800 flex items-center justify-center">
                <%= icon "receipt", class: "h-4 w-4 text-gray-400" %>
              </div>
            <% end %>
            <div>
              <p class="text-sm font-medium text-primary"><%= payment[:name] %></p>
              <p class="text-xs text-secondary"><%= payment[:due_date].strftime("%b %d") %></p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-semibold text-primary"><%= payment[:formatted_amount] %></p>
            <% if payment[:days_until] == 0 %>
              <span class="text-xs font-medium text-orange-600 theme-dark:text-orange-400">Today</span>
            <% elsif payment[:days_until] <= 3 %>
              <span class="text-xs font-medium text-red-600 theme-dark:text-red-400"><%= payment[:days_until] %>d</span>
            <% else %>
              <span class="text-xs text-secondary"><%= payment[:days_until] %>d</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
