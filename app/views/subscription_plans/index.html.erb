<div class="container mx-auto px-4 py-6">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-primary">Subscription Manager</h1>
        <p class="text-secondary mt-1">Manage your subscriptions and recurring payments</p>
      </div>
      <div>
        <%= link_to new_subscription_plan_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" do %>
          <%= icon "plus", class: "h-5 w-5" %>
          Add Subscription
        <% end %>
      </div>
    </div>
  </div>

  <!-- Dashboard Summary Cards - Theme Aware -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <!-- Monthly Recurring Revenue -->
    <div class="bg-container rounded-xl border border-primary p-5">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2.5 rounded-lg bg-green-100 theme-dark:bg-green-900/30">
            <%= icon "trending-up", class: "h-5 w-5 text-green-600 theme-dark:text-green-400" %>
          </div>
          <div>
            <p class="text-secondary text-xs font-medium uppercase tracking-wide">Monthly Revenue</p>
            <p class="text-2xl font-bold text-primary">
              <%= Money.new(@analytics.mrr, Current.family.currency).format %>
            </p>
          </div>
        </div>
      </div>
      <p class="text-xs text-secondary mt-3"><%= @active_subscriptions.count %> active subscriptions</p>
    </div>

    <!-- Active Subscriptions -->
    <div class="bg-container rounded-xl border border-primary p-5">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2.5 rounded-lg bg-blue-100 theme-dark:bg-blue-900/30">
            <%= icon "layers", class: "h-5 w-5 text-blue-600 theme-dark:text-blue-400" %>
          </div>
          <div>
            <p class="text-secondary text-xs font-medium uppercase tracking-wide">Active</p>
            <p class="text-2xl font-bold text-primary"><%= @active_subscriptions.count %></p>
          </div>
        </div>
      </div>
      <p class="text-xs text-secondary mt-3">Total subscriptions</p>
    </div>

    <!-- Upcoming Renewals -->
    <div class="bg-container rounded-xl border border-primary p-5">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2.5 rounded-lg bg-orange-100 theme-dark:bg-orange-900/30">
            <%= icon "calendar", class: "h-5 w-5 text-orange-600 theme-dark:text-orange-400" %>
          </div>
          <div>
            <p class="text-secondary text-xs font-medium uppercase tracking-wide">Renewals</p>
            <p class="text-2xl font-bold text-primary"><%= @upcoming_renewals.count %></p>
          </div>
        </div>
      </div>
      <p class="text-xs text-secondary mt-3">In next 7 days</p>
    </div>

    <!-- Overdue Payments -->
    <div class="bg-container rounded-xl border border-primary p-5">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2.5 rounded-lg bg-red-100 theme-dark:bg-red-900/30">
            <%= icon "alert-triangle", class: "h-5 w-5 text-red-600 theme-dark:text-red-400" %>
          </div>
          <div>
            <p class="text-secondary text-xs font-medium uppercase tracking-wide">Overdue</p>
            <p class="text-2xl font-bold text-primary"><%= @overdue_subscriptions.count %></p>
          </div>
        </div>
      </div>
      <p class="text-xs text-secondary mt-3">Require attention</p>
    </div>
  </div>

  <!-- Analytics Charts -->
  <%= render "subscription_plans/analytics_charts" %>

  <!-- Subscription List -->
  <div class="bg-container rounded-xl border border-primary overflow-hidden">
    <div class="px-6 py-4 border-b border-primary flex items-center justify-between">
      <h2 class="text-lg font-semibold text-primary">All Subscriptions</h2>
      <span class="text-sm text-secondary">Showing <%= @subscription_plans.count %> entries</span>
    </div>

    <% if @subscription_plans.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr class="border-b border-primary bg-surface">
              <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Service</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Amount</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Next Billing</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-secondary uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-primary/10">
            <% @subscription_plans.each do |subscription| %>
              <% service = subscription.service_merchant %>
              <tr class="hover:bg-surface-hover transition-colors <%= subscription_row_class(subscription) %>">
                <%# Service Column - Avatar + Name + Category %>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <% if service&.respond_to?(:display_logo_url) && service.display_logo_url.present? %>
                      <%= image_tag service.display_logo_url, class: "w-10 h-10 rounded-lg object-cover", loading: "lazy" %>
                    <% else %>
                      <div class="w-10 h-10 rounded-lg bg-gray-100 theme-dark:bg-gray-800 flex items-center justify-center text-xl">
                        <%= service_icon(service) %>
                      </div>
                    <% end %>
                    <div>
                      <div class="font-medium text-primary"><%= subscription.name %></div>
                      <div class="text-xs text-secondary">
                        <%= subscription_service_category(subscription)&.humanize || "Subscription" %>
                        <% if subscription.shared_within_family %>
                          <span class="ml-1 text-blue-600 theme-dark:text-blue-400">• Shared</span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </td>

                <%# Amount Column %>
                <td class="px-6 py-4">
                  <div class="font-semibold text-primary"><%= number_to_currency(subscription.amount, unit: subscription.currency + " ") %></div>
                  <div class="text-xs text-secondary"><%= subscription.billing_cycle.humanize %></div>
                </td>

                <%# Status Column %>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium <%= subscription.status_badge_class %>">
                    <%= subscription.status.humanize %>
                  </span>
                  <% if subscription.trial_days_remaining.positive? %>
                    <div class="text-xs text-blue-600 theme-dark:text-blue-400 mt-1"><%= subscription.trial_days_remaining %>d trial</div>
                  <% end %>
                </td>

                <%# Next Billing Column %>
                <td class="px-6 py-4">
                  <% if subscription.next_billing_at %>
                    <div class="text-sm text-primary"><%= subscription.next_billing_at.strftime("%b %d, %Y") %></div>
                    <% if subscription.days_until_renewal == 0 %>
                      <span class="text-xs font-medium text-orange-600 theme-dark:text-orange-400">Today</span>
                    <% elsif subscription.days_until_renewal <= 3 %>
                      <span class="text-xs font-medium text-red-600 theme-dark:text-red-400"><%= subscription.days_until_renewal %> days</span>
                    <% else %>
                      <span class="text-xs text-secondary"><%= subscription.days_until_renewal %> days</span>
                    <% end %>
                  <% else %>
                    <span class="text-sm text-secondary">—</span>
                  <% end %>
                </td>

                <%# Actions Column - Clean Dropdown Menu %>
                <td class="px-6 py-4 text-right">
                  <%= render DS::Menu.new(placement: "bottom-end") do |menu| %>
                    <% menu.with_item(variant: "link", text: "View details", href: subscription_plan_path(subscription), icon: "eye") %>
                    <% menu.with_item(variant: "link", text: "Edit", href: edit_subscription_plan_path(subscription), icon: "pencil", frame: "modal") %>

                    <% if subscription.active_or_trial? %>
                      <% menu.with_item(
                        variant: "link",
                        text: "Record payment",
                        href: new_transaction_path(account_id: subscription.account_id, nature: "outflow", subscription_plan_id: subscription.id),
                        icon: "credit-card",
                        frame: "modal"
                      ) %>
                    <% end %>

                    <% menu.with_item(variant: "divider") %>

                    <% if subscription.active? %>
                      <% menu.with_item(variant: "button", text: "Pause", href: pause_subscription_plan_path(subscription), icon: "pause", method: :patch) %>
                    <% elsif subscription.paused? %>
                      <% menu.with_item(variant: "button", text: "Resume", href: resume_subscription_plan_path(subscription), icon: "play", method: :patch) %>
                    <% end %>

                    <% menu.with_item(variant: "button", text: "Renew now", href: renew_subscription_plan_path(subscription), icon: "refresh-cw", method: :patch) %>

                    <% menu.with_item(variant: "divider") %>

                    <% if subscription.cancelled? || subscription.expired? %>
                      <% menu.with_item(
                        variant: "button",
                        text: "Delete",
                        href: subscription_plan_path(subscription),
                        icon: "trash-2",
                        method: :delete,
                        destructive: true,
                        confirm: "Are you sure you want to delete this subscription?"
                      ) %>
                    <% else %>
                      <% menu.with_item(
                        variant: "button",
                        text: "Cancel subscription",
                        href: cancel_subscription_plan_path(subscription),
                        icon: "x-circle",
                        method: :patch,
                        destructive: true
                      ) %>
                    <% end %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-16">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 theme-dark:bg-gray-800 flex items-center justify-center">
          <%= icon "layers", class: "h-8 w-8 text-gray-400" %>
        </div>
        <h3 class="text-lg font-medium text-primary mb-2">No Subscriptions Yet</h3>
        <p class="text-secondary mb-6 max-w-sm mx-auto">Start tracking your subscriptions and recurring payments to get insights.</p>
        <%= link_to new_subscription_plan_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" do %>
          <%= icon "plus", class: "h-5 w-5" %>
          Add Your First Subscription
        <% end %>
      </div>
    <% end %>
  </div>
</div>
