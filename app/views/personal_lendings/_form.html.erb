<%# locals: (account:, url:) %>

<%= render "accounts/form", account: account, url: url do |form| %>
  <%= render "shared/ruler", classes: "my-4" %>

  <div class="space-y-2">
    <%= form.fields_for :accountable do |lending_form| %>
      <%# Personal Lending is asset-only; fix direction to lending_out %>
      <%= lending_form.hidden_field :lending_direction, value: (account.new_record? ? "lending_out" : (account.accountable.lending_direction.presence || "lending_out")) %>

      <div class="flex items-center gap-2">
        <%= lending_form.select :lending_type,
                                [
                                  ["Qard Hasan (Islamic Interest-Free)", "qard_hasan"],
                                  ["Interest-Free Personal Loan", "interest_free"],
                                  ["Informal with Written Agreement", "informal_with_agreement"],
                                  ["Informal Verbal Agreement", "informal"]
                                ],
                                { label: "Loan Type" } %>
      </div>

      <div class="flex items-center gap-2">
        <%= lending_form.text_field :counterparty_name, 
                                   label: "Person's Name", 
                                   placeholder: "e.g., Ahmad, Sarah, Budi",
                                   required: true %>
        <%= lending_form.select :relationship,
                                [
                                  ["Family Member", "family"],
                                  ["Friend", "friend"],
                                  ["Colleague", "colleague"],
                                  ["Business Partner", "business_partner"],
                                  ["Neighbor", "neighbor"],
                                  ["Other", "other"]
                                ],
                                { label: "Relationship", include_blank: "Select relationship..." } %>
      </div>

      <div class="flex items-center gap-2">
        <%= lending_form.money_field :initial_amount,
                                    label: "Loan Amount",
                                    default_currency: Current.family.currency,
                                    required: true %>
        <%= lending_form.date_field :expected_return_date, 
                                   label: "Expected Return Date", 
                                   min: Date.current,
                                   required: true %>
      </div>

      <div class="flex items-center gap-2">
        <%= lending_form.select :reminder_frequency,
                                [
                                  ["No Reminders", "none"],
                                  ["Before Due Date", "before_due"],
                                  ["Weekly", "weekly"],
                                  ["Monthly", "monthly"]
                                ],
                                { label: "Reminder Frequency" } %>
      </div>

      <%# Required: Funding transfer to reflect real-world disbursement %>
      <div class="space-y-2">
        <p class="text-xs text-secondary">Funding transfer records money sent from your cash/bank account to this lending. This keeps cashflow and net worth accurate.</p>
        <%= fields_for :funding, nil, builder: StyledFormBuilder do |ff| %>
          <%= ff.collection_select :source_account_id,
                                   (@source_accounts || []),
                                   :id,
                                   :name,
                                   { label: "Funding Source (asset)", prompt: "Select account" },
                                   { required: true } %>
          <%= ff.text_field :notes, label: "Notes (optional)", placeholder: "e.g., Transfer via BCA" %>
          <p class="text-xs text-secondary">Amount equals Loan Amount. Date defaults to today. You can adjust later via quick actions.</p>
        <% end %>
      </div>

      <div class="space-y-2" data-controller="checkbox-toggle">
        <div class="flex items-center gap-2">
          <p class="text-xs text-secondary">Check to add witness and agreement details.</p>
          <%= lending_form.check_box :has_written_agreement,
                                    label: "",
                                    aria: { label: "Has written agreement" },
                                    data: { action: "change->checkbox-toggle#toggle", "checkbox-toggle-target": "checkbox" } %>
        </div>

        <div class="space-y-2 <%= 'hidden' unless account.accountable&.has_written_agreement %>" data-checkbox-toggle-target="section">
          <%= lending_form.text_field :witness_name, 
                                     label: "Witness Name (Optional)", 
                                     placeholder: "Name of witness to the agreement" %>
          <%= lending_form.text_field :contact_info, 
                                     label: "Contact Information", 
                                     placeholder: "Phone number or email for reminders" %>
          <%= lending_form.text_area :agreement_notes,
                                    label: "Agreement Details",
                                    placeholder: "Additional details about the loan agreement, terms, or Islamic compliance notes",
                                    rows: 4 %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
