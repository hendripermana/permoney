<%# locals: (account:) %>

<div class="grid grid-cols-3 gap-2">
  <%= summary_card title: "Original Amount" do %>
    <%= format_money Money.new(account.accountable.initial_amount, account.currency) %>
  <% end %>

  <%= summary_card title: "Current Balance" do %>
    <%= format_money account.balance_money %>
  <% end %>

  <%= summary_card title: "Lending Type" do %>
    <% if account.accountable.sharia_compliant? %>
      <span class="text-success"><%= account.accountable.lending_type.titleize %></span>
      <span class="text-xs text-secondary block">Sharia Compliant</span>
    <% else %>
      <%= account.accountable.lending_type.titleize %>
    <% end %>
  <% end %>

  <%= summary_card title: "Counterparty" do %>
    <%= account.accountable.counterparty_name %>
    <% if account.accountable.relationship.present? %>
      <span class="text-xs text-secondary block"><%= account.accountable.relationship.titleize %></span>
    <% end %>
  <% end %>

  <%= summary_card title: "Expected Return" do %>
    <%= account.accountable.expected_return_date&.strftime("%b %d, %Y") || "Not set" %>
    <% if account.accountable.overdue? %>
      <span class="text-xs text-danger block">Overdue</span>
    <% elsif account.accountable.days_until_due && account.accountable.days_until_due == 0 %>
      <span class="text-xs text-warning block">Due Today</span>
    <% elsif account.accountable.days_until_due && account.accountable.days_until_due <= 7 %>
      <span class="text-xs text-warning block">Due Soon</span>
    <% end %>
  <% end %>

  <%= summary_card title: "Status" do %>
    <% case account.accountable.status %>
    <% when "returned" %>
      <span class="text-success">Returned</span>
      <% if account.accountable.actual_return_date %>
        <span class="text-xs text-secondary block">
          <%= account.accountable.actual_return_date.strftime("%b %d, %Y") %>
        </span>
      <% end %>
    <% when "overdue" %>
      <span class="text-danger">Overdue</span>
      <span class="text-xs text-secondary block">
        <%= pluralize(account.accountable.days_until_due.abs, "day") %> late
      </span>
    <% when "due_soon" %>
      <% if account.accountable.days_until_due == 0 %>
        <span class="text-warning">Due Today</span>
        <span class="text-xs text-secondary block">Due today</span>
      <% else %>
        <span class="text-warning">Due Soon</span>
        <span class="text-xs text-secondary block">
          <%= pluralize(account.accountable.days_until_due, "day") %> left
        </span>
      <% end %>
    <% else %>
      <span class="text-secondary">Active</span>
    <% end %>
  <% end %>
</div>

<% if account.accountable.agreement_notes.present? || account.accountable.witness_name.present? %>
  <div class="mt-6 p-4 bg-container rounded-lg">
    <h4 class="font-medium text-primary mb-2">Agreement Details</h4>
    
    <% if account.accountable.witness_name.present? %>
      <div class="mb-2">
        <span class="text-sm text-secondary">Witness:</span>
        <span class="text-sm text-primary"><%= account.accountable.witness_name %></span>
      </div>
    <% end %>
    
    <% if account.accountable.agreement_notes.present? %>
      <div class="text-sm text-secondary">
        <%= simple_format(account.accountable.agreement_notes) %>
      </div>
    <% end %>
  </div>
<% end %>

<% unless account.accountable.status == "returned" %>
  <div class="bg-container p-4 rounded-lg mt-6">
    <h4 class="font-medium text-primary mb-4">Quick Actions</h4>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <% if account.accountable.lending_direction == "borrowing_from" %>
        <%= render DS::Link.new(
          text: "Borrow More Money",
          variant: "primary",
          icon: "plus",
          href: new_borrowing_personal_lending_path(account),
          frame: :modal,
          class: "w-full"
        ) %>
        
        <%= render DS::Link.new(
          text: "Make Payment",
          variant: "secondary",
          icon: "credit-card",
          href: new_payment_personal_lending_path(account),
          frame: :modal,
          class: "w-full"
        ) %>
      <% else %>
        <%= render DS::Link.new(
          text: "Lend More Money",
          variant: "primary",
          icon: "plus",
          href: new_lending_personal_lending_path(account),
          frame: :modal,
          class: "w-full"
        ) %>
        
        <%= render DS::Link.new(
          text: "Record Payment Received",
          variant: "secondary",
          icon: "banknote",
          href: new_payment_personal_lending_path(account),
          frame: :modal,
          class: "w-full"
        ) %>
      <% end %>
    </div>

    <div class="mt-4 pt-4 border-t border-primary">
      <div class="text-xs text-secondary space-y-1">
        <% if account.accountable.sharia_compliant? %>
          <div class="flex items-center gap-2">
            <%= icon "check-circle", size: "xs", class: "text-success" %>
            <span>Syariah Compliant - No Interest Charges</span>
          </div>
        <% end %>
        <% if account.accountable.lending_direction == "borrowing_from" %>
          <p>• Use "Borrow More" if you need additional funds from <%= account.accountable.counterparty_name %></p>
          <p>• Use "Make Payment" for partial or full repayments</p>
        <% else %>
          <p>• Use "Lend More" to record additional money lent to <%= account.accountable.counterparty_name %></p>
          <p>• Use "Record Payment" when they pay you back</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="flex justify-center py-8">
  <%= render DS::Link.new(
    text: "Edit lending details",
    variant: "ghost",
    href: edit_personal_lending_path(account),
    frame: :modal
  ) %>
</div>
