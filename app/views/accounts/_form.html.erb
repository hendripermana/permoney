<%# locals: (account:, url:, form_prefix: nil, form_data: nil, hide_account_fields: false, hide_submit: false) %>

<% form_prefix = local_assigns[:form_prefix] %>
<% custom_form_data = local_assigns[:form_data] %>
<% hide_account_fields = local_assigns.fetch(:hide_account_fields, false) %>
<% hide_submit = local_assigns.fetch(:hide_submit, false) %>
<% form_state_key = "account-form-#{account.id || account.accountable_type || "new"}" %>

<% if @error_message.present? %>
  <%= render DS::Alert.new(message: @error_message, variant: :error) %>
<% end %>

<% merged_form_data = { turbo: false }.merge(custom_form_data || {}) %>
<% merged_form_data = merged_form_data.merge(
  controller: [merged_form_data[:controller], "form-state"].compact.join(" "),
  "form-state-storage-key-value": form_state_key
) %>

<%= styled_form_with model: account, url: url, scope: :account, data: merged_form_data, class: "flex flex-col gap-4 justify-between grow text-primary" do |form| %>
  <div class="grow space-y-2">
    <%= form.hidden_field :accountable_type %>
    <%= form.hidden_field :return_to, value: params[:return_to] %>

    <%= form_prefix.call(form) if form_prefix.respond_to?(:call) %>

    <% unless hide_account_fields %>
      <%= form.text_field :name, placeholder: t(".name_placeholder"), required: "required", label: t(".name_label") %>

      <% unless account.linked? %>
        <%= form.money_field :balance,
                             label: t(".balance"),
                             required: true,
                             default_currency: Current.family.currency,
                             label_tooltip: (account.accountable_type == "Loan" ? t("loans.form.current_balance.tooltip", default: "Outstanding principal right now. Use this when you start tracking a loan that already existed.") : nil),
                             data: (account.accountable_type == "Loan" ? { "loan-form-target": "currentBalance" } : {}) %>
      <% end %>
    <% end %>

    <%= yield form %>

    <% unless hide_account_fields %>
      <details class="group">
        <summary class="cursor-pointer text-sm text-secondary hover:text-primary flex items-center gap-1 py-2">
          <%= icon "chevron-right", size: "sm", class: "group-open:rotate-90 transition-transform" %>
          Additional details
        </summary>

        <div class="space-y-2 mt-2 pl-4 border-l border-primary">
          <%= render "accounts/provider_fields",
                     form: form,
                     account: account,
                     return_to: params[:return_to] %>
        </div>
      </details>
    <% end %>
  </div>

  <% unless hide_submit %>
    <%= form.submit %>
  <% end %>
<% end %>
