<%
  currency = Current.family.currency
  
  def comparison_class(current, previous, inverse: false)
    return "text-primary" if previous.zero?
    
    change = current - previous
    is_positive_change = change > 0
    
    is_good = inverse ? !is_positive_change : is_positive_change
    
    is_good ? "text-success" : "text-tertiary"
  end
  
  def percentage_change(current, previous)
    return 0 if previous.zero?
    ((current - previous) / previous.abs * 100).round(1)
  end
%>

<div>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-medium text-primary">
      <%= t("reports.comparison.title") %>
    </h2>
    <p class="text-sm text-tertiary">
      <%= t("reports.comparison.currency", symbol: comparison_data[:currency_symbol]) %>
    </p>
  </div>

  <div class="space-y-6">
    <%# Income Comparison %>
    <div>
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-secondary flex items-center gap-2">
          <%= icon("trending-up", class: "w-4 h-4 text-success") %>
          <%= t("reports.comparison.income") %>
        </h3>
      </div>

      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="text-2xl font-semibold <%= comparison_class(comparison_data[:current][:income], comparison_data[:previous][:income]) %>">
            <%= Money.new(comparison_data[:current][:income], currency).format %>
          </span>
          <% change = percentage_change(comparison_data[:current][:income], comparison_data[:previous][:income]) %>
          <% if change != 0 %>
            <% income_improved = comparison_data[:current][:income] > comparison_data[:previous][:income] %>
            <div class="flex items-center gap-1.5">
              <span class="text-sm font-medium <%= comparison_class(comparison_data[:current][:income], comparison_data[:previous][:income]) %>">
                <%= change >= 0 ? "+" : "" %><%= change %>%
              </span>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium <%= income_improved ? 'bg-success/10 text-success' : 'bg-tertiary/10 text-tertiary' %>">
                <%= icon(income_improved ? "trending-up" : "trending-down", class: "w-3 h-3") %>
                <%= t(income_improved ? "reports.comparison.status.improved" : "reports.comparison.status.decreased") %>
              </span>
            </div>
          <% end %>
        </div>
        <span class="text-sm text-tertiary">
          <%= t("reports.comparison.previous") %>: <%= Money.new(comparison_data[:previous][:income], currency).format %>
        </span>
      </div>
    </div>

    <%# Expenses Comparison %>
    <div>
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-secondary flex items-center gap-2">
          <%= icon("trending-down", class: "w-4 h-4 text-danger") %>
          <%= t("reports.comparison.expenses") %>
        </h3>
      </div>

      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="text-2xl font-semibold <%= comparison_class(comparison_data[:current][:expenses], comparison_data[:previous][:expenses], inverse: true) %>">
            <%= Money.new(comparison_data[:current][:expenses], currency).format %>
          </span>
          <% change = percentage_change(comparison_data[:current][:expenses], comparison_data[:previous][:expenses]) %>
          <% if change != 0 %>
            <% expenses_improved = comparison_data[:current][:expenses] < comparison_data[:previous][:expenses] %>
            <div class="flex items-center gap-1.5">
              <span class="text-sm font-medium <%= comparison_class(comparison_data[:current][:expenses], comparison_data[:previous][:expenses], inverse: true) %>">
                <%= change >= 0 ? "+" : "" %><%= change %>%
              </span>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium <%= expenses_improved ? 'bg-success/10 text-success' : 'bg-tertiary/10 text-tertiary' %>">
                <%= icon(expenses_improved ? "trending-down" : "trending-up", class: "w-3 h-3") %>
                <%= t(expenses_improved ? "reports.comparison.status.reduced" : "reports.comparison.status.increased") %>
              </span>
            </div>
          <% end %>
        </div>
        <span class="text-sm text-tertiary">
          <%= t("reports.comparison.previous") %>: <%= Money.new(comparison_data[:previous][:expenses], currency).format %>
        </span>
      </div>
    </div>

    <%# Net Savings Comparison %>
    <div>
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-secondary flex items-center gap-2">
          <%= icon("piggy-bank", class: "w-4 h-4 text-primary") %>
          <%= t("reports.comparison.net_savings") %>
        </h3>
      </div>

      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-3">
          <span class="text-2xl font-semibold <%= comparison_class(comparison_data[:current][:net], comparison_data[:previous][:net]) %>">
            <%= Money.new(comparison_data[:current][:net], currency).format %>
          </span>
          <% change = percentage_change(comparison_data[:current][:net], comparison_data[:previous][:net]) %>
          <% if change != 0 %>
            <% net_improved = comparison_data[:current][:net] > comparison_data[:previous][:net] %>
            <div class="flex items-center gap-1.5">
              <span class="text-sm font-medium <%= comparison_class(comparison_data[:current][:net], comparison_data[:previous][:net]) %>">
                <%= change >= 0 ? "+" : "" %><%= change %>%
              </span>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium <%= net_improved ? 'bg-success/10 text-success' : 'bg-tertiary/10 text-tertiary' %>">
                <%= icon(net_improved ? "trending-up" : "trending-down", class: "w-3 h-3") %>
                <%= t(net_improved ? "reports.comparison.status.improved" : "reports.comparison.status.decreased") %>
              </span>
            </div>
          <% end %>
        </div>
        <span class="text-sm text-tertiary">
          <%= t("reports.comparison.previous") %>: <%= Money.new(comparison_data[:previous][:net], currency).format %>
        </span>
      </div>
    </div>
  </div>
</div>
