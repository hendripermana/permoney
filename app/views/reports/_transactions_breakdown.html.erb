<div>
  <h2 class="text-lg font-medium text-primary mb-6">
    <%= t("reports.transactions.title") %>
  </h2>

  <% if Current.family.transactions.any? %>
    <%# Export Options Bar %>
    <div class="reports-print-hide flex gap-3 mb-6 flex-wrap">
      <a href="<%= export_transactions_reports_path(params.permit(:start_date, :end_date, :period_type)) %>"
         class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-container border border-tertiary hover:bg-surface-hover text-sm font-medium text-primary transition-colors"
         data-turbo="false">
        <%= icon("download", class: "w-4 h-4") %>
        <%= t("reports.transactions.export_csv") %>
      </a>

      <button data-action="click->reports-transactions#openGoogleSheets"
              class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-container border border-tertiary hover:bg-surface-hover text-sm font-medium text-primary transition-colors">
        <%= icon("sheet", class: "w-4 h-4") %>
        <%= t("reports.transactions.export_sheets") %>
      </button>
    </div>

    <%# Income Transactions %>
    <% if transactions[:income].present? %>
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <%= icon("trending-up", class: "w-5 h-5 text-success") %>
          <h3 class="text-sm font-medium text-primary">
            <%= t("reports.transactions.income_title") %>
          </h3>
          <span class="ml-auto text-xs text-tertiary">
            <%= pluralize(transactions[:income].sum { |_, info| info[:count] }, "transaction") %>
          </span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-tertiary">
                <th class="text-left py-2 pr-4 font-medium text-secondary w-1/2">
                  <%= t("reports.transactions.category") %>
                </th>
                <th class="text-right py-2 px-4 font-medium text-secondary">
                  <%= t("reports.transactions.amount") %>
                </th>
                <th class="text-right py-2 px-4 font-medium text-secondary">
                  <%= t("reports.transactions.count") %>
                </th>
                <th class="text-right py-2 pl-4 font-medium text-secondary">
                  <%= t("reports.transactions.avg_amount") %>
                </th>
              </tr>
            </thead>
            <tbody>
              <% transactions[:income].each do |category, info| %>
                <%# Parent Category Row %>
                <tr class="border-b border-tertiary/50 hover:bg-surface-hover transition-colors font-medium">
                  <td class="py-3 pr-4">
                    <div class="flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-success"></span>
                      <span class="text-primary">
                        <%= category.name %>
                      </span>
                    </div>
                  </td>
                  <td class="text-right py-3 px-4">
                    <span class="text-success">
                      +<%= Money.new(info[:total_amount], Current.family.currency).format %>
                    </span>
                  </td>
                  <td class="text-right py-3 px-4 text-tertiary">
                    <%= info[:count] %>
                  </td>
                  <td class="text-right py-3 pl-4 text-secondary">
                    <% avg = info[:count] > 0 ? info[:total_amount] / info[:count] : 0 %>
                    <%= Money.new(avg, Current.family.currency).format %>
                  </td>
                </tr>

                <%# Subcategories %>
                <% info[:subcategories].each do |subcategory, sub_info| %>
                  <tr class="border-b border-tertiary/30 hover:bg-surface-hover transition-colors text-sm">
                    <td class="py-2 pr-4 pl-6"> <%# Indented %>
                      <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-success opacity-60"></span>
                        <span class="text-secondary">
                          <%= subcategory.name %>
                        </span>
                      </div>
                    </td>
                    <td class="text-right py-2 px-4">
                      <span class="text-success opacity-90">
                        +<%= Money.new(sub_info[:total_amount], Current.family.currency).format %>
                      </span>
                    </td>
                    <td class="text-right py-2 px-4 text-tertiary text-xs">
                      <%= sub_info[:count] %>
                    </td>
                    <td class="text-right py-2 pl-4 text-tertiary text-xs">
                       <% sub_avg = sub_info[:count] > 0 ? sub_info[:total_amount] / sub_info[:count] : 0 %>
                       <%= Money.new(sub_avg, Current.family.currency).format %>
                    </td>
                  </tr>
                <% end %>

                <%# Direct Items (Pseudo-subcategory "Other" if needed, or just listed if we want detail. 
                    For now, following the pattern: Parent total includes direct items. 
                    If we want to show direct items explicitly as a sub-row, we can. 
                    Let's stick to showing just subcategories for breakdown, assuming direct items 
                    are part of the parent's generic bucket) %>
                
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="mt-4 flex justify-end">
          <div class="text-right">
            <p class="text-xs text-tertiary mb-1"><%= t("reports.transactions.total_income") %></p>
            <p class="text-lg font-semibold text-success">
              +<%= Money.new(transactions[:income].sum { |_, info| info[:total_amount] }, Current.family.currency).format %>
            </p>
          </div>
        </div>
      </div>
    <% end %>

    <%# Expense Transactions %>
    <% if transactions[:expense].present? %>
      <div class="mb-8">
        <div class="flex items-center gap-2 mb-4">
          <%= icon("trending-down", class: "w-5 h-5 text-danger") %>
          <h3 class="text-sm font-medium text-primary">
            <%= t("reports.transactions.expense_title") %>
          </h3>
          <span class="ml-auto text-xs text-tertiary">
            <%= pluralize(transactions[:expense].sum { |_, info| info[:count] }, "transaction") %>
          </span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-tertiary">
                <th class="text-left py-2 pr-4 font-medium text-secondary w-1/2">
                  <%= t("reports.transactions.category") %>
                </th>
                <th class="text-right py-2 px-4 font-medium text-secondary">
                  <%= t("reports.transactions.amount") %>
                </th>
                <th class="text-right py-2 px-4 font-medium text-secondary">
                  <%= t("reports.transactions.count") %>
                </th>
                <th class="text-right py-2 pl-4 font-medium text-secondary">
                  <%= t("reports.transactions.avg_amount") %>
                </th>
              </tr>
            </thead>
            <tbody>
              <% transactions[:expense].each do |category, info| %>
                <%# Parent Category Row %>
                <tr class="border-b border-tertiary/50 hover:bg-surface-hover transition-colors font-medium">
                  <td class="py-3 pr-4">
                    <div class="flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-danger"></span>
                      <span class="text-primary">
                        <%= category.name %>
                      </span>
                    </div>
                  </td>
                  <td class="text-right py-3 px-4">
                    <span class="text-danger">
                      -<%= Money.new(info[:total_amount], Current.family.currency).format %>
                    </span>
                  </td>
                  <td class="text-right py-3 px-4 text-tertiary">
                    <%= info[:count] %>
                  </td>
                  <td class="text-right py-3 pl-4 text-secondary">
                    <% avg = info[:count] > 0 ? info[:total_amount] / info[:count] : 0 %>
                    <%= Money.new(avg, Current.family.currency).format %>
                  </td>
                </tr>

                <%# Subcategories %>
                <% info[:subcategories].each do |subcategory, sub_info| %>
                  <tr class="border-b border-tertiary/30 hover:bg-surface-hover transition-colors text-sm">
                    <td class="py-2 pr-4 pl-6"> <%# Indented %>
                      <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-danger opacity-60"></span>
                        <span class="text-secondary">
                          <%= subcategory.name %>
                        </span>
                      </div>
                    </td>
                    <td class="text-right py-2 px-4">
                      <span class="text-danger opacity-90">
                        -<%= Money.new(sub_info[:total_amount], Current.family.currency).format %>
                      </span>
                    </td>
                    <td class="text-right py-2 px-4 text-tertiary text-xs">
                      <%= sub_info[:count] %>
                    </td>
                    <td class="text-right py-2 pl-4 text-tertiary text-xs">
                       <% sub_avg = sub_info[:count] > 0 ? sub_info[:total_amount] / sub_info[:count] : 0 %>
                       <%= Money.new(sub_avg, Current.family.currency).format %>
                    </td>
                  </tr>
                <% end %>

              <% end %>
            </tbody>
          </table>
        </div>

        <div class="mt-4 flex justify-end">
          <div class="text-right">
            <p class="text-xs text-tertiary mb-1"><%= t("reports.transactions.total_expenses") %></p>
            <p class="text-lg font-semibold text-danger">
              -<%= Money.new(transactions[:expense].sum { |_, info| info[:total_amount] }, Current.family.currency).format %>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-8 text-tertiary">
      <%= t("reports.transactions.no_data") %>
    </div>
  <% end %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const link = document.querySelector('[data-download-google-sheets]');
      if (link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          window.location.href = '<%= google_sheets_instructions_reports_path(params.permit(:start_date, :end_date, :period_type)) %>';
        });
      }
    });
</script>
