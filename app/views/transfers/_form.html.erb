<% accounts = Current.family.accounts.manual.includes(:accountable).alphabetically %>
<% accounts_data = accounts.each_with_object({}) do |account, data| %>
  <% entry = { accountableType: account.accountable_type, currency: account.currency } %>
  <% if account.accountable_type == "PreciousMetal" %>
    <% metal = account.accountable %>
    <% entry.merge!(
      preciousMetal: true,
      unit: metal.unit,
      manualPrice: metal.manual_price&.to_s,
      manualPriceCurrency: metal.manual_price_currency.presence || account.currency
    ) %>
  <% end %>
  <% data[account.id] = entry %>
<% end %>
<% save_price_checked = ActiveModel::Type::Boolean.new.cast(params.dig(:transfer, :save_price)) %>

<%= styled_form_with model: transfer,
                     class: "space-y-4",
                     data: {
                       turbo_frame: "_top",
                       controller: "transfer-form",
                       "transfer-form-accounts-value": json_escape(accounts_data.to_json)
                     } do |f| %>
  <% if transfer.errors.present? %>
    <div class="text-destructive flex items-center gap-2">
      <%= icon "circle-alert", size: "sm" %>
      <p class="text-sm"><%= @transfer.errors.full_messages.to_sentence %></p>
    </div>
  <% end %>

  <section>
    <%= render "shared/transaction_type_tabs", active_tab: "transfer" %>
  </section>

  <section class="space-y-2">
    <%= f.collection_select :from_account_id,
                            accounts,
                            :id,
                            :name,
                            { prompt: t(".select_account"), label: t(".from") },
                            required: true,
                            data: {
                              "transfer-form-target": "fromAccount",
                              action: "change->transfer-form#updateToAccountOptions"
                            } %>
    <%= f.collection_select :to_account_id,
                            accounts,
                            :id,
                            :name,
                            { prompt: t(".select_account"), label: t(".to") },
                            required: true,
                            data: {
                              "transfer-form-target": "toAccount",
                              action: "change->transfer-form#updateToAccountOptions"
                            } %>
    <%= f.number_field :amount,
                       label: t(".amount"),
                       required: true,
                       min: 0,
                       placeholder: "100",
                       step: 0.00000001,
                       value: params.dig(:transfer, :amount),
                       data: {
                         "transfer-form-target": "amount",
                         action: "input->transfer-form#syncDerivedFields"
                       } %>
    <%= f.date_field :date, value: transfer.inflow_transaction&.entry&.date || Date.current, label: t(".date"), required: true, max: Date.current %>
  </section>

  <section class="space-y-3" data-transfer-form-target="preciousMetalFields" hidden>
    <div class="space-y-2">
      <div class="flex items-end gap-2">
        <div class="grow">
          <%= f.number_field :metal_quantity,
                             label: "Grams",
                             placeholder: "0.000",
                             min: 0,
                             step: 0.001,
                             value: params.dig(:transfer, :metal_quantity),
                             data: {
                               "transfer-form-target": "quantity",
                               action: "input->transfer-form#syncDerivedFields"
                             } %>
        </div>
        <span class="text-xs text-secondary pb-2" data-transfer-form-target="unitLabel">g</span>
      </div>

      <% if transfer.errors[:quantity].present? %>
        <p class="text-xs text-destructive"><%= transfer.errors[:quantity].to_sentence %></p>
      <% end %>
    </div>

    <div class="space-y-2">
      <div class="flex items-end gap-2">
        <div class="grow">
          <%= f.number_field :price_per_unit,
                             label: "Price per gram",
                             placeholder: "0.00",
                             min: 0,
                             step: 0.000001,
                             value: params.dig(:transfer, :price_per_unit),
                             data: {
                               "transfer-form-target": "price",
                               action: "input->transfer-form#syncDerivedFields"
                             } %>
        </div>
        <span class="text-xs text-secondary pb-2" data-transfer-form-target="priceCurrencyLabel"><%= Current.family.currency %></span>
      </div>

      <%= f.hidden_field :price_currency,
                         value: params.dig(:transfer, :price_currency) || Current.family.currency,
                         data: { "transfer-form-target": "priceCurrency" } %>

      <% if transfer.errors[:price_per_unit].present? %>
        <p class="text-xs text-destructive"><%= transfer.errors[:price_per_unit].to_sentence %></p>
      <% end %>
    </div>

    <%= f.number_field :fee_amount,
                       label: "Fee (money)",
                       min: 0,
                       placeholder: "0.00",
                       step: 0.00000001,
                       value: params.dig(:transfer, :fee_amount),
                       data: { "transfer-form-target": "fee" } %>

    <div class="flex items-center gap-2">
      <%= render DS::Toggle.new(
        id: "transfer_save_price",
        name: "transfer[save_price]",
        checked: save_price_checked
      ) %>
      <%= label_tag "transfer_save_price", "Save price as default", class: "text-sm text-primary" %>
    </div>

    <p class="text-xs text-secondary">Enter either amount or grams. We'll calculate the other using the price per gram.</p>
  </section>

  <% if params[:account_id].present? %>
    <% suggested_account = Current.family.accounts.find_by(id: params[:account_id]) %>
    <% if suggested_account&.accountable_type == "Loan" && suggested_account.accountable.personal_loan? %>
      <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg">
        <div class="flex items-start gap-2">
          <%= icon "info", size: "sm", class: "text-amber-600 mt-0.5" %>
          <div class="text-sm text-amber-800">
            <p class="font-medium mb-1">Personal Loan Transfer</p>
            <p>This appears to be a payment related to your personal loan with <%= suggested_account.accountable.counterparty_name || "a person" %>.</p>
            <p class="mt-2">
              <%= link_to "Use enhanced payment form instead", new_payment_loan_path(suggested_account), 
                          class: "underline hover:no-underline text-amber-700", data: { turbo_frame: :modal } %>
            </p>
          </div>
        </div>
      </div>
    <% elsif suggested_account&.accountable_type == "PersonalLending" %>
      <div class="bg-amber-50 border border-amber-200 p-4 rounded-lg">
        <div class="flex items-start gap-2">
          <%= icon "info", size: "sm", class: "text-amber-600 mt-0.5" %>
          <div class="text-sm text-amber-800">
            <p class="font-medium mb-1">Personal Lending Transfer</p>
            <p>This appears to be a payment related to your personal lending with <%= suggested_account.accountable.counterparty_name %>.</p>
            <p class="mt-2">
              <%= link_to "Use enhanced payment form instead", new_payment_personal_lending_path(suggested_account), 
                          class: "underline hover:no-underline text-amber-700", data: { turbo_frame: :modal } %>
            </p>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <section>
    <%= f.submit t(".submit") %>
  </section>
<% end %>
